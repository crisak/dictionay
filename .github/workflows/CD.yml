name: CD

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target Environment"
        required: true
        default: "development"
        type: choice
        options:
          - development
          - production
      app:
        description: "Application to Deploy"
        required: true
        default: "mobile"
        type: choice
        options:
          - mobile
          - mobile-amplify
          - sls-api
          - all

concurrency:
  group: manual-deploy-${{ github.event.inputs.app }}-${{ github.event.inputs.environment }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "20.x"

jobs:
  # Job para validar permisos de usuario
  validate-permissions:
    name: Validate User Permissions
    runs-on: ubuntu-latest
    steps:
      - name: Check if user is authorized
        run: |
          AUTHORIZED_USERS=("crisak")
          CURRENT_USER="${{ github.actor }}"

          if [[ ! " ${AUTHORIZED_USERS[@]} " =~ " ${CURRENT_USER} " ]]; then
            echo "❌ User ${CURRENT_USER} is not authorized to run manual deployments"
            echo "Authorized users: ${AUTHORIZED_USERS[*]}"
            exit 1
          fi

          echo "✅ User ${CURRENT_USER} is authorized to deploy"
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Application: ${{ github.event.inputs.app }}"

  # Setup compartido para todos los jobs
  setup:
    name: Setup Dependencies
    runs-on: ubuntu-latest
    needs: validate-permissions
    outputs:
      node-version: ${{ steps.node.outputs.node-version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Retrieve Node.js and dependencies
        uses: ./.github/actions/setup

      - name: Set Node.js version output
        id: node
        run: echo "node-version=${{ env.NODE_VERSION }}" >> $GITHUB_OUTPUT

  deploy-mobile-amplify:
    name: Deploy Mobile App - Amplify
    runs-on: ubuntu-latest
    needs: setup
    if: github.event.inputs.app == 'mobile-amplify' || github.event.inputs.app == 'all'
    environment: ${{ github.event.inputs.environment }}
    env:
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
      TURBO_TEAM: ${{ vars.TURBO_TEAM }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Retrieve Node.js and dependencies
        uses: ./.github/actions/setup

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.PNP_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.PNP_AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.PNP_AWS_REGION }}
      - name: Build in ${{ github.event.inputs.environment }} environment
        run: |
          if [[ "${{ github.event.inputs.environment }}" == "development" ]]; then
            yarn turbo run build:dev --filter=mobile
          else
            yarn turbo run build:prod --filter=mobile
          fi

      - name: Print detail last commit
        run: |
          echo "Last commit details:"
          echo "Author: ${{ github.actor }}"
          echo "Commit SHA: ${{ github.sha }}"
          echo "Commit Message: ${{ github.event.head_commit.message }}"
          echo "Branch: ${{ github.ref_name }}"

      - name: Prepare mobile app for deployment
        working-directory: apps/mobile
        run: |
          zip -r build.zip .next/ public/ package.json next.config.js
          echo "Mobile app prepared for deployment"

      - name: Deploy to Amplify
        working-directory: apps/mobile
        run: |
          # Start deployment
          JOB_ID=$(aws amplify start-job \
            --app-id ${{ vars.PNP_DEMO_AMPLIFY_APP_ID }} \
            --branch-name ${{ github.ref_name }} \
            --job-type RELEASE \
            --commit-id ${{ github.sha }} \
            --commit-message "GA CD: by ${{ github.actor }} for ${{ github.event.inputs.environment }} environment" \
            --query 'jobSummary.jobId' \
            --output text)

          echo "⌛ Deployment started with Job ID: $JOB_ID"

          # Monitorear el progreso del job manualmente
          echo "Monitoring deployment progress..."
          TIMEOUT=1800  # 30 minutos timeout
          ELAPSED=0

          while [ $ELAPSED -lt $TIMEOUT ]; do
            JOB_STATUS=$(aws amplify get-job \
              --app-id ${{ vars.PNP_DEMO_AMPLIFY_APP_ID }} \
              --branch-name ${{ github.ref_name }} \
              --job-id $JOB_ID \
              --query 'job.summary.status' \
              --output text)
            
            echo "Job status: $JOB_STATUS (${ELAPSED}s elapsed)"
            
            case $JOB_STATUS in
              "SUCCEED")
                echo "✨ Deployment completed successfully!"
                exit 0
                ;;
              "FAILED"|"CANCELLED")
                echo "🚨 Deployment failed with status: $JOB_STATUS"
                
                # Get details of the failed job
                aws amplify get-job \
                  --app-id ${{ vars.PNP_DEMO_AMPLIFY_APP_ID }} \
                  --branch-name ${{ github.ref_name }} \
                  --job-id $JOB_ID \
                  --query 'job.summary.jobArn' \
                  --output text
                
                exit 1
                ;;
              "PENDING"|"PROVISIONING"|"RUNNING")
                echo "⏳ Job still running... waiting 30 seconds"
                sleep 30
                ELAPSED=$((ELAPSED + 30))
                ;;
              *)
                echo "🤔 Unknown status: $JOB_STATUS"
                sleep 30
                ELAPSED=$((ELAPSED + 30))
                ;;
            esac
          done

          echo "⌛ Deployment timed out after ${TIMEOUT} seconds"
          exit 1

  # Deploy Mobile App (Next.js to Vercel)
  deploy-mobile:
    name: Deploy Mobile App
    runs-on: ubuntu-latest
    needs: setup
    if: github.event.inputs.app == 'mobile' || github.event.inputs.app == 'all'
    environment: ${{ github.event.inputs.environment }}
    env:
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
      TURBO_TEAM: ${{ vars.TURBO_TEAM }}
      VERCEL_ENV_DEV: ${{ github.event.inputs.environment == 'development' && '--env NODE_ENV=development' || '' }}
      VERCEL_ENV_ARG_PROD: ${{ github.event.inputs.environment == 'production' && '--prod' || '' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Retrieve Node.js and dependencies
        uses: ./.github/actions/setup

      - name: Build Mobile App
        run: |
          if [[ "${{ github.event.inputs.environment }}" == "development" ]]; then
            yarn turbo run build:dev --filter=mobile
          else
            yarn turbo run build:prod --filter=mobile
          fi
        env:
          NODE_ENV: ${{ github.event.inputs.environment }}
          NEXT_PUBLIC_RUN_ENVIRONMENT: ${{ vars.NEXT_PUBLIC_RUN_ENVIRONMENT }}

      - name: Define Vercel Environment Argument
        run: |
          echo "NEXT_PUBLIC_RUN_ENVIRONMENT=${{ vars.NEXT_PUBLIC_RUN_ENVIRONMENT }}" >> $GITHUB_ENV

      - name: Build Vercel
        working-directory: apps/mobile
        run: |
          echo "NEXT_PUBLIC_RUN_ENVIRONMENT=$NEXT_PUBLIC_RUN_ENVIRONMENT" >> .env
          npx vercel build --token ${{ secrets.VERCEL_TOKEN }} --scope ${{ secrets.VERCEL_ORG_ID }} --yes ${{ env.VERCEL_ENV_ARG_PROD }}

      - name: Print Environment Variables
        run: |
          echo "vercel-token: ${{ secrets.VERCEL_TOKEN }}"
          echo "vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}"
          echo "vercel-project-id: ${{ secrets.VERCEL_MOBILE_PROJECT_ID }}"
          echo "vercel-environment-arg: ${{ env.VERCEL_ENV_DEV }} / ${{ env.VERCEL_ENV_ARG_PROD }}" 
          echo "NODE_ENV: ${{ github.event.inputs.environment }}"
          echo 'Current directory:' $(pwd)
          echo 'Directory contents:'
          ls -la
          echo 'Directory mobile contents:'
          ls -la apps/mobile

      - name: Deploy to Vercel
        working-directory: apps/mobile
        run: |
          echo "Directory: $(pwd)"
          ls -la
          npx vercel deploy --token ${{ secrets.VERCEL_TOKEN }} --scope ${{ secrets.VERCEL_ORG_ID }} --env NODE_ENV=development --prebuilt --yes ${{ env.VERCEL_ENV_ARG_PROD }}

      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_MOBILE_PROJECT_ID }}
          working-directory: apps/mobile
          vercel-args: ${{ env.VERCEL_ENV_DEV }} ${{ env.VERCEL_ENV_ARG_PROD }} --prebuilt --archive=tgz
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

      - name: Deployment Summary
        run: |
          echo "🚀 Mobile App deployed successfully!"
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Deployed by: ${{ github.actor }}"
          echo "Commit: ${{ github.sha }}"

  # Deploy SLS API (Serverless to AWS)
  deploy-sls-api:
    name: Deploy SLS API
    runs-on: ubuntu-latest
    needs: setup
    if: github.event.inputs.app == 'sls-api' || github.event.inputs.app == 'all'
    environment: ${{ github.event.inputs.environment }}
    env:
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
      TURBO_TEAM: ${{ vars.TURBO_TEAM }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Retrieve Node.js and dependencies
        uses: ./.github/actions/setup

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Deploy to AWS
        working-directory: ./apps/sls-api
        run: |
          if [[ "${{ github.event.inputs.environment }}" == "development" ]]; then
            yarn deploy:dev
          else
            yarn deploy:prod
          fi
        env:
          NODE_ENV: ${{ github.event.inputs.environment || matrix.environment }}

          SLS_STAGE: ${{ vars.SLS_STAGE }}
          SLS_KEY_ALARM: ${{ secrets.SLS_KEY_ALARM }}
          SLS_DB_NAME: ${{ secrets.SLS_DB_NAME }}
          SLS_DB_PASSWORD: ${{ secrets.SLS_DB_PASSWORD }}
          SLS_DB_USERNAME: ${{ secrets.SLS_DB_USERNAME }}
          SLS_GIF_API_KEY: ${{ secrets.SLS_GIF_API_KEY }}
          SLS_GIF_ENDPOINT: ${{ secrets.SLS_GIF_ENDPOINT }}
          SLS_IA_API_KEY: ${{ secrets.SLS_IA_API_KEY }}
          SLS_IMG_ACCESS_KEY: ${{ secrets.SLS_IMG_ACCESS_KEY }}
          SLS_IMG_ENDPOINT: ${{ secrets.SLS_IMG_ENDPOINT }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}

          SERVERLESS_ACCESS_KEY: ${{ secrets.SERVERLESS_ACCESS_KEY }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Deployment Summary
        run: |
          echo "🚀 SLS API deployed successfully!"
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Stage: ${{ vars.SLS_STAGE }}"
          echo "Deployed by: ${{ github.actor }}"
          echo "Commit: ${{ github.sha }}"

  # Notificación final
  notify-completion:
    name: Notify Deployment Completion
    runs-on: ubuntu-latest
    needs: [deploy-mobile, deploy-sls-api]
    if: always() && (needs.deploy-mobile.result == 'success' || needs.deploy-sls-api.result == 'success')
    steps:
      - name: Success Notification
        if: (needs.deploy-mobile.result == 'success' && github.event.inputs.app == 'mobile') || (needs.deploy-sls-api.result == 'success' && github.event.inputs.app == 'sls-api')
        run: |
          echo "✅ Manual deployment completed successfully!"
          echo "📱 Application: ${{ github.event.inputs.app }}"
          echo "🌍 Environment: ${{ github.event.inputs.environment }}"
          echo "👤 Deployed by: ${{ github.actor }}"
          echo "📝 Commit: ${{ github.sha }}"
          echo "🕒 Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

      - name: Failure Notification
        if: (needs.deploy-mobile.result == 'failure' && github.event.inputs.app == 'mobile') || (needs.deploy-sls-api.result == 'failure' && github.event.inputs.app == 'sls-api')
        run: |
          echo "❌ Manual deployment failed!"
          echo "📱 Application: ${{ github.event.inputs.app }}"
          echo "🌍 Environment: ${{ github.event.inputs.environment }}"
          echo "👤 Attempted by: ${{ github.actor }}"
          echo "📝 Commit: ${{ github.sha }}"
          echo "🕒 Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          exit 1
